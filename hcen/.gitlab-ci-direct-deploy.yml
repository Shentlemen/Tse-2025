# GitLab CI/CD Pipeline - Direct WAR Deployment to Virtuozzo
# No Docker needed! Deploys WAR directly to WildFly on Virtuozzo/Jelastic
#
# Virtuozzo Environment Variables (set in GitLab CI/CD Settings):
# - VZ_API_HOST: e.g., app.minube.antel.com.uy
# - VZ_ENV_NAME: e.g., hcen-prod
# - VZ_TOKEN: Virtuozzo API token (or VZ_USER + VZ_PASSWORD)

stages:
  - build
  - test
  - package
  - deploy

variables:
  GRADLE_OPTS: "-Dorg.gradle.daemon=false"
  GRADLE_USER_HOME: "$CI_PROJECT_DIR/hcen/.gradle"

cache:
  paths:
    - hcen/.gradle/wrapper
    - hcen/.gradle/caches

# Default settings for all jobs
default:
  before_script:
    - cd hcen
    - pwd
    - ls -la

# ============================================
# Stage 1: Build
# ============================================
build:
  stage: build
  image: eclipse-temurin:24-jdk
  script:
    - chmod +x ./gradlew
    - ./gradlew assemble
  artifacts:
    paths:
      - hcen/build/libs/*.war
      - hcen/build/classes/
    expire_in: 1 hour

# ============================================
# Stage 2: Test
# ============================================
test:
  stage: test
  image: eclipse-temurin:24-jdk
  script:
    - chmod +x ./gradlew
    - ./gradlew test
  artifacts:
    when: always
    reports:
      junit:
        - hcen/build/test-results/test/**/TEST-*.xml
    paths:
      - hcen/build/reports/tests/test/
    expire_in: 1 week

# ============================================
# Stage 3: Package
# ============================================
package:
  stage: package
  image: eclipse-temurin:24-jdk
  script:
    - chmod +x ./gradlew
    - ./gradlew war
    - echo "WAR file built:"
    - ls -lh build/libs/*.war
  artifacts:
    paths:
      - hcen/build/libs/*.war
    expire_in: 1 month
  only:
    - main
    - develop
    - tags

# ============================================
# Stage 4: Deploy to Virtuozzo WildFly
# ============================================

# Deploy to Staging (automatic on develop branch)
deploy_staging:
  stage: deploy
  image: curlimages/curl:8.5.0
  needs: ["package"]
  dependencies:
    - package
  variables:
    VZ_DEPLOY_ENV: "${VZ_ENV_NAME_STAGING:-hcen-staging}"
  before_script:
    - cd "$CI_PROJECT_DIR/hcen"
    - ls -la build/libs/
  script:
    - echo "Deploying to Virtuozzo Staging environment..."
    - echo "Environment: $VZ_DEPLOY_ENV"
    - echo "API Host: $VZ_API_HOST"

    # Get session token if not provided
    - |
      if [ -z "$VZ_TOKEN" ]; then
        echo "Obtaining Virtuozzo session token..."
        VZ_TOKEN=$(curl -s -X POST "https://${VZ_API_HOST}/1.0/users/authentication/rest/signin" \
          -d "login=${VZ_USER}&password=${VZ_PASSWORD}" \
          | grep -oP '(?<="session":")[^"]*')
        echo "Token obtained: ${VZ_TOKEN:0:10}..."
      fi

    # Upload WAR file to Virtuozzo
    - |
      echo "Uploading WAR file..."
      curl -X POST "https://${VZ_API_HOST}/1.0/environment/file/rest/upload" \
        -H "session: $VZ_TOKEN" \
        -F "envName=$VZ_DEPLOY_ENV" \
        -F "path=/opt/jboss/wildfly/standalone/deployments/" \
        -F "file=@build/libs/hcen-1.0-SNAPSHOT.war;filename=hcen.war" \
        -o deploy-response.json

    - cat deploy-response.json
    - grep -q '"result":0' deploy-response.json && echo "✓ Deployment successful!" || (echo "✗ Deployment failed!" && exit 1)

    # Restart WildFly to pick up new deployment
    - |
      echo "Restarting WildFly..."
      curl -X POST "https://${VZ_API_HOST}/1.0/environment/control/rest/restartnode" \
        -d "envName=$VZ_DEPLOY_ENV" \
        -d "session=$VZ_TOKEN" \
        -d "nodeId=${VZ_NODE_ID}" \
        -o restart-response.json

    - cat restart-response.json

    # Wait for service to come back up
    - echo "Waiting for service to restart (30 seconds)..."
    - sleep 30

    # Health check
    - |
      echo "Checking application health..."
      curl -f "https://${VZ_DEPLOY_ENV}.${VZ_API_HOST}/hcen/health" || echo "Health check endpoint not available (this is OK if not implemented yet)"

    - echo "Deployment complete! Application available at: https://${VZ_DEPLOY_ENV}.${VZ_API_HOST}/hcen/"

  environment:
    name: staging
    url: https://${VZ_ENV_NAME_STAGING}.${VZ_API_HOST}/hcen/
  only:
    - develop

# Deploy to Production (manual trigger on main branch)
deploy_production:
  stage: deploy
  image: curlimages/curl:8.5.0
  needs: ["package"]
  dependencies:
    - package
  variables:
    VZ_DEPLOY_ENV: "${VZ_ENV_NAME}"
  before_script:
    - cd "$CI_PROJECT_DIR/hcen"
    - ls -la build/libs/
  script:
    - echo "Deploying to Virtuozzo Production environment..."
    - echo "Environment: $VZ_DEPLOY_ENV"
    - echo "API Host: $VZ_API_HOST"
    - echo "⚠️  PRODUCTION DEPLOYMENT - Please verify!"

    # Get session token if not provided
    - |
      if [ -z "$VZ_TOKEN" ]; then
        echo "Obtaining Virtuozzo session token..."
        VZ_TOKEN=$(curl -s -X POST "https://${VZ_API_HOST}/1.0/users/authentication/rest/signin" \
          -d "login=${VZ_USER}&password=${VZ_PASSWORD}" \
          | grep -oP '(?<="session":")[^"]*')
        echo "Token obtained: ${VZ_TOKEN:0:10}..."
      fi

    # Upload WAR file
    - |
      echo "Uploading WAR file..."
      curl -X POST "https://${VZ_API_HOST}/1.0/environment/file/rest/upload" \
        -H "session: $VZ_TOKEN" \
        -F "envName=$VZ_DEPLOY_ENV" \
        -F "path=/opt/jboss/wildfly/standalone/deployments/" \
        -F "file=@build/libs/hcen-1.0-SNAPSHOT.war;filename=hcen.war" \
        -o deploy-response.json

    - cat deploy-response.json
    - grep -q '"result":0' deploy-response.json && echo "✓ Deployment successful!" || (echo "✗ Deployment failed!" && exit 1)

    # Restart WildFly
    - |
      echo "Restarting WildFly..."
      curl -X POST "https://${VZ_API_HOST}/1.0/environment/control/rest/restartnode" \
        -d "envName=$VZ_DEPLOY_ENV" \
        -d "session=$VZ_TOKEN" \
        -d "nodeId=${VZ_NODE_ID}" \
        -o restart-response.json

    - cat restart-response.json

    # Wait for restart
    - echo "Waiting for service to restart (30 seconds)..."
    - sleep 30

    # Smoke test
    - |
      echo "Running smoke tests..."
      curl -f "https://${VZ_DEPLOY_ENV}.${VZ_API_HOST}/hcen/" || echo "⚠️  Application may not be responding yet"

    - echo "✓ Production deployment complete!"
    - echo "Application URL: https://${VZ_DEPLOY_ENV}.${VZ_API_HOST}/hcen/"

  environment:
    name: production
    url: https://${VZ_ENV_NAME}.${VZ_API_HOST}/hcen/
  only:
    - main
  when: manual  # Require manual approval for production

# Alternative: Deploy using FTP (simpler but less control)
deploy_ftp:
  stage: deploy
  image: alpine:latest
  needs: ["package"]
  dependencies:
    - package
  before_script:
    - apk add --no-cache lftp
    - cd "$CI_PROJECT_DIR/hcen"
  script:
    - echo "Deploying via FTP..."
    - |
      lftp -c "
        set ftp:ssl-allow no;
        open -u ${VZ_FTP_USER},${VZ_FTP_PASSWORD} ftp://${VZ_FTP_HOST};
        cd /opt/jboss/wildfly/standalone/deployments/;
        put build/libs/hcen-1.0-SNAPSHOT.war -o hcen.war;
        bye
      "
    - echo "✓ WAR uploaded via FTP. WildFly will auto-deploy."
  only:
    - main
  when: manual
