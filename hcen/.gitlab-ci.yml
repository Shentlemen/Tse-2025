# GitLab CI/CD Pipeline for Java 24 + Jakarta EE Application
# Optimized for OpenShift deployment with WildFly runtime

stages:
  - build
  - test
  - package
  - docker_build
  - push
  - deploy

variables:
  GRADLE_OPTS: "-Dorg.gradle.daemon=false"
  GRADLE_USER_HOME: "$CI_PROJECT_DIR/.gradle"
  IMAGE_TAG: "$CI_COMMIT_SHORT_SHA"
  DOCKER_DRIVER: overlay2
  # GitLab Registry built-ins (CI_REGISTRY, CI_REGISTRY_IMAGE, CI_REGISTRY_USER, CI_REGISTRY_PASSWORD) are provided automatically when registry enabled.
  # Virtuozzo (Jelastic) deployment variables (add these in GitLab CI/CD settings):
  # VZ_API_HOST        -> e.g. paas.minube.antel.com (without protocol)
  # VZ_ENV_NAME        -> environment name in Virtuozzo
  # VZ_NODE_ID         -> numeric node id of the custom Docker container (or use VZ_NODE_GROUP instead)
  # VZ_TOKEN           -> session token; OR provide VZ_USER and VZ_PASSWORD to let script obtain one
  # Optional: VZ_NODE_GROUP (e.g. cp) if you prefer redeploying group instead of a single node

# OpenShift legacy section removed. Now deploying via Virtuozzo (Jelastic) custom Docker container.
# Flow: build/test/package -> docker_build (construct WildFly image with WAR) -> push (to GitLab Registry) -> deploy_virtuozzo (API redeploy with new tag).

cache:
  paths:
    - .gradle/wrapper
    - .gradle/caches

build:
  stage: build
  image: eclipse-temurin:24-jdk
  script:
    - chmod +x ./gradlew
    - ./gradlew assemble
  artifacts:
    paths:
      - build/libs/*.war
      - build/classes/
    expire_in: 1 hour

test:
  stage: test
  image: eclipse-temurin:24-jdk
  script:
    - chmod +x ./gradlew
    - ./gradlew test
  artifacts:
    when: always
    reports:
      junit:
        - build/test-results/test/**/TEST-*.xml
    paths:
      - build/reports/tests/test/
    expire_in: 1 week

package:
  stage: package
  image: eclipse-temurin:24-jdk
  script:
    - chmod +x ./gradlew
    - ./gradlew war
  artifacts:
    paths:
      - build/libs/*.war
    expire_in: 1 month
  only:
    - main
    - develop
    - tags

docker_build:
  stage: docker_build
  image: docker:24.0.7
  services:
    - name: docker:24.0.7-dind
      command: ["--tls=false"]
  needs: ["package"]
  dependencies:
    - package
  variables:
    DOCKER_TLS_CERTDIR: ""  # disable TLS for dind
  script:
    - cd "$CI_PROJECT_DIR" # ensure root
    - ls -l build/libs
    - echo "Building image $CI_REGISTRY_IMAGE:$IMAGE_TAG"
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" "$CI_REGISTRY"
    - docker build -t "$CI_REGISTRY_IMAGE:$IMAGE_TAG" -t "$CI_REGISTRY_IMAGE:latest" .
    - docker images | grep "$CI_REGISTRY_IMAGE" || true
  artifacts:
    name: docker_build_$CI_COMMIT_SHORT_SHA
    paths:
      - Dockerfile
    expire_in: 1 week
  only:
    - main
    - develop
    - tags

push_image:
  stage: push
  image: docker:24.0.7
  services:
    - name: docker:24.0.7-dind
      command: ["--tls=false"]
  needs: ["docker_build"]
  dependencies:
    - docker_build
  variables:
    DOCKER_TLS_CERTDIR: ""
  script:
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" "$CI_REGISTRY"
    - docker push "$CI_REGISTRY_IMAGE:$IMAGE_TAG"
    - docker push "$CI_REGISTRY_IMAGE:latest"
  only:
    - main
    - develop
    - tags

deploy_virtuozzo:
  stage: deploy
  image: curlimages/curl:8.5.0
  needs: ["push_image"]
  variables:
    # allow override of tag (e.g. manual redeploy older tag)
    DEPLOY_IMAGE_TAG: "$IMAGE_TAG"
  script:
    - echo "Starting Virtuozzo redeploy of tag $DEPLOY_IMAGE_TAG"
    - chmod +x scripts/vz-deploy.sh
    - ./scripts/vz-deploy.sh "$DEPLOY_IMAGE_TAG"
  environment:
    name: production
    url: https://$VZ_ENV_NAME.$VZ_API_HOST  # Adjust if platform gives different domain pattern
  only:
    - main
  when: manual