# GitLab CI/CD Pipeline for Java 24 + Jakarta EE Application
# Optimized for OpenShift deployment with WildFly runtime

stages:
  - build
  - test
  - package
  - docker
  - deploy

variables:
  GRADLE_OPTS: "-Dorg.gradle.daemon=false"
  GRADLE_USER_HOME: "$CI_PROJECT_DIR/hcen/.gradle"
  IMAGE_TAG: "$CI_COMMIT_SHORT_SHA"
  DOCKER_DRIVER: overlay2
  # GitLab Registry built-ins (CI_REGISTRY, CI_REGISTRY_IMAGE, CI_REGISTRY_USER, CI_REGISTRY_PASSWORD) are provided automatically when registry enabled.
  # Virtuozzo (Jelastic) deployment variables (add these in GitLab CI/CD settings):
  # VZ_API_HOST        -> e.g. paas.minube.antel.com (without protocol)
  # VZ_ENV_NAME        -> environment name in Virtuozzo
  # VZ_NODE_ID         -> numeric node id of the custom Docker container (or use VZ_NODE_GROUP instead)
  # VZ_TOKEN           -> session token; OR provide VZ_USER and VZ_PASSWORD to let script obtain one
  # Optional: VZ_NODE_GROUP (e.g. cp) if you prefer redeploying group instead of a single node
cache:
  paths:
    - hcen/.gradle/wrapper
    - hcen/.gradle/caches

# Default settings for all jobs
default:
  before_script:
    - cd hcen
    - pwd
    - ls -la

build:
  stage: build
  image: eclipse-temurin:24-jdk
  script:
    - chmod +x ./gradlew
    - ./gradlew assemble
  artifacts:
    paths:
      - hcen/build/libs/*.war
      - hcen/build/classes/
    expire_in: 1 hour

test:
  stage: test
  image: eclipse-temurin:24-jdk
  script:
    - chmod +x ./gradlew
    - ./gradlew test
  artifacts:
    when: always
    reports:
      junit:
        - hcen/build/test-results/test/**/TEST-*.xml
    paths:
      - hcen/build/reports/tests/test/
    expire_in: 1 week

package:
  stage: package
  image: eclipse-temurin:24-jdk
  script:
    - chmod +x ./gradlew
    - ./gradlew war
  artifacts:
    paths:
      - hcen/build/libs/*.war
    expire_in: 1 month
  only:
    - main
    - develop
    - tags

docker_build_and_push:
  stage: docker
  image: docker:24.0.7
  services:
    - name: docker:24.0.7-dind
      command: ["--tls=false"]
  needs: ["package"]
  dependencies:
    - package
  variables:
    DOCKER_TLS_CERTDIR: ""
    DOCKER_HOST: tcp://docker:2375
  before_script:
    - cd "$CI_PROJECT_DIR"
    - ls -la
    - until docker info; do sleep 1; done
  script:
    - ls -l hcen/build/libs
    - echo "Registry: $CI_REGISTRY"
    - echo "Registry Image: $CI_REGISTRY_IMAGE"
    - echo "Building image ${CI_REGISTRY_IMAGE}:${IMAGE_TAG}"
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" "$CI_REGISTRY"
    - docker build -t "${CI_REGISTRY_IMAGE}:${IMAGE_TAG}" -t "${CI_REGISTRY_IMAGE}:latest" hcen/
    - docker images
    - docker push "${CI_REGISTRY_IMAGE}:${IMAGE_TAG}"
    - echo "Successfully pushed ${CI_REGISTRY_IMAGE}:${IMAGE_TAG} and ${CI_REGISTRY_IMAGE}:latest"
  only:
    - main
    - develop
    - tags

deploy_virtuozzo:
  stage: deploy
  image: curlimages/curl:8.5.0
  needs: ["docker_build_and_push"]
  variables:
    # allow override of tag (e.g. manual redeploy older tag)
    DEPLOY_IMAGE_TAG: "$IMAGE_TAG"
  before_script:
    - cd "$CI_PROJECT_DIR" # start at repo root
    - ls -la
  script:
    - echo "Starting Virtuozzo redeploy of tag $DEPLOY_IMAGE_TAG"
    - chmod +x hcen/scripts/vz-deploy.sh
    - ./hcen/scripts/vz-deploy.sh "$DEPLOY_IMAGE_TAG"
  environment:
    name: production
    url: https://$VZ_ENV_NAME.$VZ_API_HOST  # Adjust if platform gives different domain pattern
  only:
    - main
  when: manual