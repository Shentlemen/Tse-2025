# GitLab CI/CD Pipeline for Java 24 + Jakarta EE Application
# Optimized for OpenShift deployment with WildFly runtime

stages:
  - build
  - test
  - package
  - docker
  - deploy

variables:
  GRADLE_OPTS: "-Dorg.gradle.daemon=false"
  GRADLE_USER_HOME: "$CI_PROJECT_DIR/hcen/.gradle"
  IMAGE_TAG: "$CI_COMMIT_SHORT_SHA"
  # Docker-in-Docker configuration (GitLab official recommendation)
  DOCKER_HOST: tcp://docker:2376
  DOCKER_TLS_CERTDIR: "/certs"
  DOCKER_TLS_VERIFY: 1
  DOCKER_CERT_PATH: "$DOCKER_TLS_CERTDIR/client"
  # Container image variables
  CONTAINER_TEST_IMAGE: "$CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG"
  CONTAINER_RELEASE_IMAGE: "$CI_REGISTRY_IMAGE:latest"
  # Virtuozzo (Jelastic) deployment variables (add these in GitLab CI/CD settings):
  # VZ_API_HOST        -> e.g. paas.minube.antel.com (without protocol)
  # VZ_ENV_NAME        -> environment name in Virtuozzo
  # VZ_NODE_ID         -> numeric node id of the custom Docker container (or use VZ_NODE_GROUP instead)
  # VZ_TOKEN           -> session token; OR provide VZ_USER and VZ_PASSWORD to let script obtain one
  # Optional: VZ_NODE_GROUP (e.g. cp) if you prefer redeploying group instead of a single node

cache:
  paths:
    - hcen/.gradle/wrapper
    - hcen/.gradle/caches

# Default settings for all jobs
default:
  before_script:
    - cd hcen
    - pwd
    - ls -la

build:
  stage: build
  image: eclipse-temurin:24-jdk
  script:
    - chmod +x ./gradlew
    - ./gradlew assemble
  artifacts:
    paths:
      - hcen/build/libs/*.war
      - hcen/build/classes/
    expire_in: 1 hour

test:
  stage: test
  image: eclipse-temurin:24-jdk
  script:
    - chmod +x ./gradlew
    - ./gradlew test
  artifacts:
    when: always
    reports:
      junit:
        - hcen/build/test-results/test/**/TEST-*.xml
    paths:
      - hcen/build/reports/tests/test/
    expire_in: 1 week

package:
  stage: package
  image: eclipse-temurin:24-jdk
  script:
    - chmod +x ./gradlew
    - ./gradlew war
  artifacts:
    paths:
      - hcen/build/libs/*.war
    expire_in: 1 month
  only:
    - main
    - develop
    - tags

# Docker build using GitLab's official recommended configuration
docker_build:
  stage: docker
  image: docker:24.0.5-cli
  services:
    - docker:24.0.5-dind
  needs: ["package"]
  dependencies:
    - package
  before_script:
    - cd "$CI_PROJECT_DIR"
    - ls -la hcen/build/libs
    - echo "$CI_REGISTRY_PASSWORD" | docker login $CI_REGISTRY -u $CI_REGISTRY_USER --password-stdin
  script:
    - echo "Building Docker image..."
    - echo "Registry:" $CI_REGISTRY
    - echo "Image:" $CI_REGISTRY_IMAGE
    - echo "Tag:" $IMAGE_TAG
    - docker build --pull -t $CI_REGISTRY_IMAGE:$IMAGE_TAG -t $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG hcen/
    - docker images
    - docker push $CI_REGISTRY_IMAGE:$IMAGE_TAG
    - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG
    - echo "Successfully pushed image:" $CI_REGISTRY_IMAGE:$IMAGE_TAG
  only:
    - main
    - develop
    - tags

# Release latest tag (only on main branch)
docker_release:
  stage: docker
  image: docker:24.0.5-cli
  services:
    - docker:24.0.5-dind
  needs: ["docker_build"]
  before_script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login $CI_REGISTRY -u $CI_REGISTRY_USER --password-stdin
  script:
    - echo "Releasing image as latest..."
    - docker pull "$CI_REGISTRY_IMAGE:$IMAGE_TAG"
    - docker tag "$CI_REGISTRY_IMAGE:$IMAGE_TAG" "$CONTAINER_RELEASE_IMAGE"
    - docker push "$CONTAINER_RELEASE_IMAGE"
    - echo "Successfully released:" $CONTAINER_RELEASE_IMAGE
  only:
    - main

deploy_virtuozzo:
  stage: deploy
  image: curlimages/curl:8.5.0
  needs: ["docker_release"]
  variables:
    # allow override of tag (e.g. manual redeploy older tag)
    DEPLOY_IMAGE_TAG: "$IMAGE_TAG"
  before_script:
    - cd "$CI_PROJECT_DIR" # start at repo root
    - ls -la
  script:
    - echo "Starting Virtuozzo redeploy of tag $DEPLOY_IMAGE_TAG"
    - chmod +x hcen/scripts/vz-deploy.sh
    - ./hcen/scripts/vz-deploy.sh "$DEPLOY_IMAGE_TAG"
  environment:
    name: production
    url: https://$VZ_ENV_NAME.$VZ_API_HOST  # Adjust if platform gives different domain pattern
  only:
    - main
  when: manual
